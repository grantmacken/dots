name: Dotfiles Management - Foundation Testing
on:
  push:
    branches:
      - main
  # Allow manual triggering for testing
  workflow_dispatch:
jobs:
  foundation-validation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
      - name: Install GNU Stow
        run: sudo apt-get update && sudo apt-get install -y stow
      - name: Foundational Checks
        run: |
          make check-tools
          make check-root
      - name: Initialize directories
        run: |
          make init
          dot-local/bin/validate-init
      - name: Debug - List repo contents
        run: |
          echo "=== Root directory ==="
          ls -la
          echo "=== Checking for .config ==="
          if [ -e .config ]; then
            echo ".config exists:"
            ls -ld .config
            file .config
          else
            echo ".config does not exist"
          fi
      - name: Verify deployment would succeed - dry-run conflict check
        run: make verify
      - name: Deploy dotfiles
        run: |
          make default
          dot-local/bin/validate-stow
      - name: Install Neovim
        run: |
          sudo apt-get update
          sudo apt-get install -y neovim
      - name: Verify Neovim launches
        run: dot-local/bin/validate-nvim
