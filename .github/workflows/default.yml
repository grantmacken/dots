name: Dotfiles Management - Foundation Testing
on:
  # Allow manual triggering for testing
  workflow_dispatch:

jobs:
  foundation-validation:
    runs-on: ubuntu-latest
    # Use Fedora Silverblue as the container base
    container:
      image: quay.io/fedora/fedora-silverblue:latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Display environment info
        run: |
          echo "=== Environment Information ==="
          cat /etc/os-release
          echo ""
          echo "=== Container Check ==="
          if [ -f /run/.containerenv ]; then
            cat /run/.containerenv
          else
            echo "WARNING: Not in a container environment"
          fi

      - name: Setup toolbox
        run: |
          echo "=== Setting up toolbox ==="
          echo "1. Installing toolbox if needed..."
          command -v toolbox || dnf install -y toolbox
          
          echo ""
          echo "2. Pulling toolbox image..."
          podman pull ghcr.io/grantmacken/tbx-coding:latest
          
          echo ""
          echo "3. Creating toolbox container..."
          toolbox create --image ghcr.io/grantmacken/tbx-coding:latest tbx-coding || echo "Toolbox already exists"
          
          echo ""
          echo "4. Verifying toolbox..."
          toolbox list

      - name: Verify toolbox detection
        run: |
          echo "=== Testing check-toolbox script inside toolbox ==="
          chmod +x dot-local/bin/check-toolbox || true
          toolbox run --container tbx-coding bash -c "cd $PWD && ./dot-local/bin/check-toolbox"

      - name: Verify required tools
        run: |
          echo "=== Testing check-tools script inside toolbox ==="
          chmod +x dot-local/bin/check-tools || true
          toolbox run --container tbx-coding bash -c "cd $PWD && ./dot-local/bin/check-tools"

      - name: Test repository root detection
        run: |
          echo "=== Testing check-repo-root script inside toolbox ==="
          chmod +x dot-local/bin/check-repo-root || true
          toolbox run --container tbx-coding bash -c "cd $PWD && ./dot-local/bin/check-repo-root"

      - name: Run make check-toolbox
        run: |
          echo "=== Testing make check-toolbox target inside toolbox ==="
          chmod +x dot-local/bin/* || true
          toolbox run --container tbx-coding bash -c "cd $PWD && make check-toolbox"

      - name: Run make check-tools
        run: |
          echo "=== Testing make check-tools target inside toolbox ==="
          toolbox run --container tbx-coding bash -c "cd $PWD && make check-tools"
