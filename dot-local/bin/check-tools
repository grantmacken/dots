#!/usr/bin/env bash
# Toolbox Tool Verification
# Verifies required CLI tools and versions are available in tbx-coding toolbox
# Based on requirements from .specify/001-plan.md Phase 0.1

set -euo pipefail

# Minimum required versions
MIN_STOW="2.3"
MIN_MAKE="4.0"
MIN_GIT="2.30"
MIN_SYSTEMD="245"
MIN_NVIM="0.9"

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

error_count=0

# Version comparison helper (returns 0 if v1 >= v2)
version_gte() {
  printf '%s\n%s\n' "$2" "$1" | sort -V -C
}

# Check GNU Stow
if command -v stow &>/dev/null; then
  stow_ver=$(stow --version 2>&1 | head -1 | grep -oP '\d+\.\d+' || echo "0.0")
  if version_gte "$stow_ver" "$MIN_STOW"; then
    echo -e "${GREEN}✓ GNU Stow: $stow_ver (>= $MIN_STOW)${NC}"
  else
    echo -e "${YELLOW}⚠ GNU Stow: $stow_ver (minimum: $MIN_STOW)${NC}"
    ((error_count++))
  fi
else
  echo -e "${RED}✗ GNU Stow: NOT FOUND${NC}" >&2
  ((error_count++))
fi

# Check GNU Make
if command -v make &>/dev/null; then
  make_ver=$(make --version 2>&1 | head -1 | grep -oP '\d+\.\d+' || echo "0.0")
  if version_gte "$make_ver" "$MIN_MAKE"; then
    echo -e "${GREEN}✓ GNU Make: $make_ver (>= $MIN_MAKE)${NC}"
  else
    echo -e "${YELLOW}⚠ GNU Make: $make_ver (minimum: $MIN_MAKE)${NC}"
    ((error_count++))
  fi
else
  echo -e "${RED}✗ GNU Make: NOT FOUND${NC}" >&2
  ((error_count++))
fi

# Check Git
if command -v git &>/dev/null; then
  git_ver=$(git --version 2>&1 | grep -oP '\d+\.\d+' || echo "0.0")
  if version_gte "$git_ver" "$MIN_GIT"; then
    echo -e "${GREEN}✓ Git: $git_ver (>= $MIN_GIT)${NC}"
  else
    echo -e "${YELLOW}⚠ Git: $git_ver (minimum: $MIN_GIT)${NC}"
    ((error_count++))
  fi
else
  echo -e "${RED}✗ Git: NOT FOUND${NC}" >&2
  ((error_count++))
fi

# Check systemctl
if command -v systemctl &>/dev/null; then
  systemd_ver=$(systemctl --version 2>&1 | head -1 | grep -oP '\d+' | head -1 || echo "0")
  if version_gte "$systemd_ver" "$MIN_SYSTEMD"; then
    echo -e "${GREEN}✓ systemctl (systemd): $systemd_ver (>= $MIN_SYSTEMD)${NC}"
  else
    echo -e "${YELLOW}⚠ systemctl (systemd): $systemd_ver (minimum: $MIN_SYSTEMD)${NC}"
    ((error_count++))
  fi
else
  echo -e "${RED}✗ systemctl: NOT FOUND${NC}" >&2
  ((error_count++))
fi

# Check Neovim
if command -v nvim &>/dev/null; then
  nvim_ver=$(nvim --version 2>&1 | head -1 | grep -oP '\d+\.\d+' || echo "0.0")
  if version_gte "$nvim_ver" "$MIN_NVIM"; then
    echo -e "${GREEN}✓ Neovim: $nvim_ver (>= $MIN_NVIM)${NC}"
  else
    echo -e "${YELLOW}⚠ Neovim: $nvim_ver (minimum: $MIN_NVIM)${NC}"
    ((error_count++))
  fi
else
  echo -e "${RED}✗ Neovim: NOT FOUND${NC}" >&2
  ((error_count++))
fi

echo ""

# Summary
if [ $error_count -eq 0 ]; then
  echo -e "${GREEN}✓ All required tools present with minimum versions${NC}"
  exit 0
else
  echo -e "${RED}✗ $error_count tool(s) missing or below minimum version${NC}" >&2
  echo ""
  echo "To fix, ensure you're using the correct toolbox image:"
  echo "  toolbox create --image ghcr.io/grantmacken/tbx-coding:latest tbx-coding"
  exit 1
fi
