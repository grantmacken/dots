#!/usr/bin/env bash
# nvim-health-to-issue - Convert Neovim health check to GitHub issue
# Usage: nvim-health-to-issue
# Description: Captures :checkhealth output and creates/updates a single GitHub issue with checkboxes

set -euo pipefail

# Get repo root directory
REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null)" || {
  echo "Error: Not in a git repository" >&2
  exit 1
}

# T-H001: Use tmp/ directory relative to repo root
TMP_DIR="${REPO_ROOT}/tmp"
HEALTH_OUTPUT="${TMP_DIR}/nvim-health-raw.txt"

# T-H003: Add cleanup trap
cleanup() {
  if [[ -f "$HEALTH_OUTPUT" ]]; then
    rm -f "$HEALTH_OUTPUT"
  fi
}

trap cleanup EXIT

error() {
  echo "Error: $*" >&2
  exit 1
}

main() {
  echo "Neovim Health Check to GitHub Issue"
  echo "Repo Root: $REPO_ROOT"
  echo "Output File: $HEALTH_OUTPUT"
  
  # Ensure tmp directory exists
  mkdir -p "$TMP_DIR"
  
  # T-H002: Implement headless health check capture
  echo "Running :checkhealth..."
  if ! nvim --headless "+checkhealth" "+qa" &> "$HEALTH_OUTPUT"; then
    error "Failed to run :checkhealth"
  fi
  
  echo "✓ Health check output captured to: $HEALTH_OUTPUT"
  echo "✓ File will be cleaned up on script exit"
  
  # Display first 10 lines as confirmation
  echo ""
  echo "Preview (first 10 lines):"
  head -n 10 "$HEALTH_OUTPUT"
}

main "$@"
