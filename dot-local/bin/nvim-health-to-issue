#!/usr/bin/env bash
# nvim-health-to-issue - Convert Neovim health check to GitHub issue
# Usage: nvim-health-to-issue
# Description: Captures :checkhealth output and creates/updates a single GitHub issue with checkboxes

set -euo pipefail

TEMP_FILE=""

cleanup() {
  if [[ -n "$TEMP_FILE" && -f "$TEMP_FILE" ]]; then
    rm -f "$TEMP_FILE"
  fi
}

trap cleanup EXIT

error() {
  echo "Error: $*" >&2
  exit 1
}

capture_health_check() {
  TEMP_FILE=$(mktemp /tmp/nvim-health.XXXXXX)
  
  echo "Capturing Neovim health check..."
  
  # Run nvim headless with checkhealth command and write output to temp file
  if ! nvim --headless -c "checkhealth" -c "write! $TEMP_FILE" -c "quit" &>/dev/null; then
    error "Failed to run nvim --headless checkhealth"
  fi
  
  if [[ ! -s "$TEMP_FILE" ]]; then
    error "Health check output is empty"
  fi
  
  echo "✓ Health check captured to: $TEMP_FILE"
  echo "✓ Output size: $(wc -l < "$TEMP_FILE") lines"
}

main() {
  echo "Neovim Health Check to GitHub Issue"
  echo ""
  
  # T-H002: Capture health check output
  capture_health_check
  
  echo ""
  echo "Preview first 20 lines:"
  head -20 "$TEMP_FILE"
}

main "$@"
